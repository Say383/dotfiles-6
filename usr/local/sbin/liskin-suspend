#!/usr/bin/env bash

set -eu

# avoid concurrent executions
exec {lock_fd}>"/run/liskin-suspend.lock"
flock --nonblock "$lock_fd" || exit

! pgrep -t tty`fgconsole` X >/dev/null && exit

pidof -q /usr/bin/xsecurelock && locked=: || locked=

if [[ $locked ]]; then
	lsmod | grep -q nvidia && exit
	systemctl suspend
else
	loginctl lock-sessions

	if [[ ${1-} == "button" ]]; then
		chvt 1 || :
	fi
fi
