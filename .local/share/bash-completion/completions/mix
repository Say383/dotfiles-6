#!bash

function _init_completion_cache {
	cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/bash-completion"
	mkdir -p "$cache_dir" || return

	# prune cache
	find "${cache_dir:?}"/ -type f -mtime +30 -print -delete || return
}

function __file_older_than {
	local last now
	last=$(date +%s --reference="${1:?}")
	now=$(date +%s)
	(( last + ${2:?} < now ))
}

function _mix_gen_cache() (
	# lock to avoid overloading the CPU with concurrent refreshes
	exec {lock_fd}>"${1:?}.lock"
	flock --nonblock "$lock_fd" || return

	tmp="${1:?}.$BASHPID" || return
	mix help --names >"$tmp" || return
	mv -f "$tmp" "${1:?}" || return
)

function _mix {
	local cur prev words cword
	_init_completion || return

	# only complete first argument
	if [[ $cword != 1 ]]; then
		_filedir
		return
	fi

	local cache_dir
	_init_completion_cache || return

	local cache_entry
	read -r cache_entry _ < <({ echo mix; pwd -P; } | sha1sum -b) || return

	if [[ -f "$cache_dir/$cache_entry" ]]; then
		# if the cache is not really fresh, refresh
		# (do it in the background so that we're fast now and correct later)
		if __file_older_than "$cache_dir/$cache_entry" 10; then
			(_mix_gen_cache "$cache_dir/$cache_entry" &)
		fi
	else
		_mix_gen_cache "$cache_dir/$cache_entry" || return
	fi

	readarray -t COMPREPLY < <(compgen -W "$(< "$cache_dir/$cache_entry")" -- "$cur")
}

complete -F _mix mix
