#!/usr/bin/env bash

# Volume up/down via:
#  - bluetooth AVRCP (if avilable and default sink)
#  - pulseaudio (otherwise)
#
# Motivation: lowering volume in software degrades quality as the upper bits
# are unused.

set -eu

export LANG=C

if [[ ${1-} != @(up|down) ]]; then
	echo 'up|down expected'
	exit 1
fi

function volume-bluetooth {
	local method
	[[ $1 == up ]] && method=VolumeUp || method=VolumeDown
	dbus-send \
		--print-reply --type=method_call \
		--system --dest=org.bluez \
		/org/bluez/hci0/dev_"$2" org.bluez.MediaControl1."$method" >/dev/null
}

function volume-pulseaudio {
	local sign
	[[ $1 == up ]] && sign="+" || sign="-"
	pactl set-sink-volume @DEFAULT_SINK@ "$sign"2%
}

if [[ $(pactl info) =~ "Default Sink: bluez_sink."([0-9A-F_]*)".a2dp_sink" ]]; then
	bt_addr="${BASH_REMATCH[1]}"
	volume-bluetooth "$1" "$bt_addr" && exit 0
fi

volume-pulseaudio "$1"
