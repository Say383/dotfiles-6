#!/usr/bin/env bash

# Attach a netns created by vpnns (https://github.com/cernekee/ocproxy)
# without attaching its userns (chrome's sandbox doesn't work in there).

set -eu

function o { printf -->&2 "%s:%s\\n" "${0##*/}" "$(printf " %q" "$@")"; "$@"; }

options=$(unset GETOPT_COMPATIBLE && getopt -o "" --long name: -- "$@")
eval "set -- $options"

name=default
while (( $# )); do
	opt=$1; shift
	case "$opt" in
		--name) name=$1; shift ;;
		--) break ;;
	esac
done

pid=$(< ~/.vpnns-"$name"/vpnns.pid)
env=$(systemctl --user show-environment)
env_quoted=$(printf "%q " "$env")
arg_quoted=$(printf "%q " "$@")
o sudo \
	nsenter --target "$pid" --net \
	sudo -u "$USER" \
	bwrap \
		--bind /{,} \
		--dev-bind /dev{,} \
		--ro-bind "$HOME"/.vpnns-"$name"/etc/resolv.conf "$(readlink -f /etc/resolv.conf)" \
		--ro-bind "$HOME"/bin/.vpnns-nsswitch.conf "$(readlink -f /etc/nsswitch.conf)" \
		-- \
	bash -c "set -a; eval $env_quoted; set +a; exec $arg_quoted"
