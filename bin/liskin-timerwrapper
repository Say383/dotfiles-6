#!/usr/bin/env bash

set -eu

: "${TIMER_WRAPPER_TIMEOUT=120}"

function o { printf -->&2 "%s:%s\\n" "${0##*/}" "$(printf " %q" "$@")"; "$@"; }

timeout=()
(( ${TIMER_WRAPPER_TIMEOUT:-0} > 0 )) && timeout=(timeout "$TIMER_WRAPPER_TIMEOUT")

o "${timeout[@]}" "$@" && ret=$? || ret=$?

if (( ret != 0 )); then
	mail -s "timer failed: $* ($ret)" "$USER"@localhost <<<"check journal"
	sleep 2  # avoid killing forked exim4 trying to deliver results
fi

exit "$ret"
