#!/usr/bin/env bash

set -eu -o pipefail
shopt -s lastpipe

function o { printf -->&2 "%s:%s\\n" "${0##*/}" "$(printf " %q" "$@")"; "$@"; }

function release-tree {
	: "${1:?tag-name expected}"

	tree="$(o git mktree)"
	commit="$(o git commit-tree -p @ "$tree" -m "$1" </dev/tty)"
	o git tag -s "$1" "$commit" </dev/tty
}

function release-xrandr-smart {
	: "${1:?version expected}"

	make -C .local/share/man man1/xrandr-smart.1
	manpage=$(o git hash-object -w .local/share/man/man1/xrandr-smart.1)

	{
		git ls-tree --full-tree @:bin xrandr-smart
		printf "100644 blob %s\txrandr-smart.1\n" "$manpage"
	} | release-tree xrandr-smart-"$1"
}

toplevel="$(git rev-parse --show-toplevel 2>/dev/null)"
o cd "$toplevel"

o "$@"
