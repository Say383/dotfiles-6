#!/usr/bin/env bash

set -eu
shopt -s nullglob globstar lastpipe

prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=( "$prefix"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

entry=$(printf '%s\n' "${password_files[@]}" | dmenu -p "pass entry" "$@")

entry_content=$(pass show "$entry")

if [[ ${1-} == @(pw|) ]]; then
	pass=$(<<<"$entry_content" head -1)
else
	pass=$(<<<"$entry_content" sed -n -e '/^---$/,/^\.\.\.$/p' | yq -r -e ".$1")
fi

printf '%s' "$pass" | xdotool type --clearmodifiers --delay 0 --file -
