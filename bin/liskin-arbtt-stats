#!/usr/bin/env bash

set -eu -o pipefail
shopt -s lastpipe

function o { printf -->&2 "%s:%s\\n" "${0##*/}" "$(printf " %q" "$@")"; "$@"; }

function date-range {
	d1=$(date -d "${1:-yesterday}" +%F)
	d2=$(date -d "${2:-$d1 + 1 day}" +%F)
}

function activity {
	date-range "$@"
	for log in ~/.arbtt/capture-:?.log; do
		o arbtt-stats --logfile="$log" --filter="\$date >= ${d1}03:00 && \$date < ${d2}03:00" --min-percentage=0 --category=Activity
		echo
	done
}

function details {
	date-range "$@"
	for log in ~/.arbtt/capture-:?.log; do
		o arbtt-stats --logfile="$log" --filter="\$date >= ${d1}03:00 && \$date < ${d2}03:00" --each-category
		echo
	done
}

function uncategorized-dump-samples {
	date-range "$@"
	grep -P -o '\bActivity:[\w_-]+' ~/.arbtt/categorize.cfg | sort -u \
		| grep -v '[-]Fallback$' \
		| readarray -t excludes
	for log in ~/.arbtt/capture-:?.log; do
		o arbtt-stats --logfile="$log" --filter="\$date >= ${d1}03:00 && \$date < ${d2}03:00" --dump-samples "${excludes[@]/#/--exclude=}"
	done
}

function uncategorized-current-window {
	uncategorized-dump-samples "$@" | grep -F '(*)' | sort | uniq --count | sort -n
}

make --silent -C ~/.arbtt

(( $# )) || set -- activity
"$@"
