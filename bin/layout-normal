#!/usr/bin/env bash

set -eu
shopt -s lastpipe

xrandr --current \
| grep -P -o '^(\S+)(?= (dis)?connected)' \
| grep -v -x -F eDP-1 \
| readarray -t outputs

outputs_off=()
for o in "${outputs[@]}"; do
	outputs_off+=(--output "$o" --off)
done

xrandr \
	--output eDP-1 --mode 1920x1080 --pos 0x0 --panning 0x0 --dpi 96 --gamma 1.15:1.15:1.15 --primary \
	"${outputs_off[@]}"

xinput map-to-output 'Raydium Corporation Raydium Touch System' eDP-1 || :
xinput set-prop 'SynPS/2 Synaptics TouchPad' 'libinput Natural Scrolling Enabled' 1 || :
xinput set-prop 'SynPS/2 Synaptics TouchPad' 'libinput Accel Speed' 0.3 || :
xinput set-prop 'SynPS/2 Synaptics TouchPad' 'libinput Middle Emulation Enabled' 1 || :
xinput set-prop 'SynPS/2 Synaptics TouchPad' 'libinput Disable While Typing Enabled' 0 || :
xinput set-prop 'TPPS/2 IBM TrackPoint' 'libinput Accel Speed' -0.3 || :

# kernel/intel bug workaround, reenable dpms when undocked
perl -i -pe 's/dpmsEnabled:\s*\K\w+/True/' ~/.xscreensaver
if ! xscreensaver-command -time | grep -q ': screen locked since'; then
	systemctl --user restart xscreensaver.service
fi
xset +dpms
